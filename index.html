<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Willow — Notes • Library • Physics Graph • Forecasting</title>
<link rel="preconnect" href="https://d3js.org">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
/* ============ THEME ============ */
:root{
  --ink:#111827; --muted:#6b7280; --bg:#f8fafc; --panel:#ffffff;
  --line:#e5e7eb; --chip:#f3f4f6; --btn:#f9fafb; --link:#0ea5e9;
  --g-edge:#cbd5e1; --g-node:#0ea5e9; --g-stroke:#0f172a;
  --g-label:#0f172a; --g-focus:#fb7185; --g-bg:#ffffff;
}
[data-theme="dark"]{
  --ink:#e5e7eb; --muted:#9ca3af; --bg:#0b1020; --panel:#0f172a;
  --line:#1f2937; --chip:#111827; --btn:#111827; --link:#38bdf8;
  --g-edge:#334155; --g-node:#22d3ee; --g-stroke:#e5e7eb;
  --g-label:#e5e7eb; --g-focus:#fb7185; --g-bg:#0f172a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
header{padding:12px 20px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;background:var(--panel);position:sticky;top:0;z-index:5}
.title{display:flex;gap:10px;align-items:baseline}.title h1{margin:0;font-size:18px}
.nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.nav a{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:var(--panel);text-decoration:none;color:inherit}
.nav a.active{background:var(--ink);color:var(--panel)}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.grid-3{display:grid;grid-template-columns:260px 1fr 300px;gap:16px}
.pane{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px}
.tabs{display:flex;gap:8px}.tab{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:var(--panel);cursor:pointer;color:var(--ink)}.tab.active{background:var(--chip)}
.list{border-top:1px solid var(--line);margin-top:10px;max-height:70vh;overflow:auto}
.item{padding:10px;border-bottom:1px dashed var(--line);cursor:pointer}.item .t{font-weight:600}.muted{color:var(--muted)}
.row{display:flex;gap:10px;align-items:center}.row.space{justify-content:space-between}
.btn{background:var(--btn);border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer;color:var(--ink)}
input[type="text"],textarea,select{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;background:var(--panel);color:var(--ink);font:inherit}
textarea{min-height:260px;resize:vertical}
.chips{display:flex;gap:6px;flex-wrap:wrap}.chip{background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--ink)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;color:var(--muted)}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px;cursor:pointer;display:flex;flex-direction:column}
.card .title{font-weight:700;font-size:13px;margin-bottom:6px}.card .preview{color:var(--muted);font-size:12px;flex:1}.card .meta{display:flex;gap:8px;color:var(--muted);font-size:11px;margin-top:6px}
#gwrap{position:relative}
#gcanvas{width:100%;height:520px;border:1px solid var(--line);border-radius:12px;background:var(--panel);display:block;touch-action:none}
.tooltip{position:absolute;pointer-events:none;background:var(--ink);color:var(--panel);padding:6px 8px;border-radius:8px;font-size:12px;opacity:0;transition:opacity .15s}
.footer{text-align:center;color:var(--muted);font-size:12px;margin:12px 0 24px}
.note-card{background:var(--panel);border:1px dashed var(--line);border-radius:12px;padding:10px}
.projects-bar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.proj{display:flex;align-items:center;gap:8px;border:1px solid var(--line);background:var(--panel);border-radius:999px;padding:6px 10px;cursor:pointer}
.proj .count{background:rgba(99,102,241,.15);border:1px solid rgba(99,102,241,.35);border-radius:999px;padding:2px 6px;font-size:11px}
.badge{border:1px solid var(--line);padding:2px 6px;border-radius:999px;font-size:11px;background:var(--btn);color:var(--ink)}
.gctrls{display:flex;gap:14px;align-items:center;margin-bottom:10px;flex-wrap:wrap}

/* ============ UX Additions (toasts + modal) ============ */
#toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
.toast{background:var(--panel);border:1px solid var(--line);border-left:6px solid #10b981;border-radius:10px;padding:10px 12px;box-shadow:0 6px 18px rgba(0,0,0,.25);min-width:220px;max-width:380px;display:flex;align-items:flex-start;gap:10px}
.toast.warn{border-left-color:#f59e0b}
.toast.err{border-left-color:#ef4444}
.toast .t-close{margin-left:auto;cursor:pointer;border:none;background:transparent;color:var(--muted);font-size:16px;line-height:1;padding:0}
.toast .t-title{font-weight:700;margin-right:6px}
.toast .t-text{font-size:13px;color:var(--ink)}
.shake{animation:shake .32s cubic-bezier(.36,.07,.19,.97) both}
@keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9998}
.modal{background:var(--panel);border:1px solid var(--line);border-radius:12px;max-width:720px;width:min(92vw,720px);padding:12px;display:flex;flex-direction:column;gap:10px}
.modal h3{margin:0;font-size:16px}
.modal .actions{display:flex;gap:10px;justify-content:flex-end}
.modal textarea{min-height:160px}
.badge.kbd{font-family:ui-monospace, monospace; font-size:11px; border-style:solid; border-width:1px; padding:2px 6px; border-radius:6px}

.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="title">
    <h1>Willow</h1><span class="muted">Notes • Library • Physics Graph • Forecast</span>
  </div>
  <nav class="nav">
    <a href="#/notecard" id="nav-notecard" class="active">Notecard</a>
    <a href="#/library" id="nav-library">Library</a>
    <a href="#/graph" id="nav-graph">Graph</a>
    <a href="#/forecast" id="nav-forecast">Forecast</a>
    <span class="muted">•</span>
    <button id="btn-export" class="btn">Export</button>
    <label class="btn" style="cursor:pointer"><input id="file-import" type="file" accept="application/json" style="display:none"> Import</label>
    <button id="btn-theme" class="btn" title="Toggle dark mode">Theme</button>
  </nav>
</header>

<main class="wrap">
  <!-- ===== Notecard ===== -->
  <section id="view-notecard" class="grid-3">
    <aside class="pane">
      <div class="tabs">
        <button id="tab-notes" class="tab active">Notes</button>
        <button id="tab-suggestions" class="tab">Suggestions</button>
      </div>
      <div id="left-list" class="list"></div>
    </aside>
    <section class="pane">
      <input id="nc-title" type="text" placeholder="Title (new note)">
      <textarea id="nc-content" placeholder="Text (new note). Use [[wikilinks]] to connect notes."></textarea>
      <div class="row space" style="margin-top:6px">
        <div class="row">
          <button id="btn-save" class="btn">Save</button>
          <button id="btn-new" class="btn">New</button>
        </div>
        <label class="btn"><input id="file-attach" type="file" style="display:none"> Attach file (metadata)</label>
      </div>
      <input id="nc-tags" type="text" placeholder="#Tags comma or #prefix">
      <div id="tag-chips" class="chips" style="margin-top:6px"></div>

      <div class="row" style="margin-top:10px">
        <select id="debate-agent" style="width:auto">
          <option value="Historian">Historian</option>
          <option value="Economist">Economist</option>
          <option value="Contrarian">Contrarian</option>
          <option value="BlindSpot">Blind Spot</option>
          <option value="Interconnectedness">Interconnectedness</option>
        </select>
        <button id="debate-ask" class="btn">Ask AI</button>
        <button id="debate-add" class="btn">Add to note</button>
      </div>
      <div class="row space" style="margin-top:6px"><div class="muted">AI inserts history</div><span class="small">Tip: <span class="badge kbd">⌘/Ctrl</span> + <span class="badge kbd">Enter</span> to ask</span></div>
      <pre id="debate-output" class="mono" style="white-space:pre-wrap"></pre>
      <div id="debate-history" class="list"></div>
    </section>
    <aside class="pane">
      <div class="row space">
        <div class="muted">Suggested Links</div>
        <button class="btn" id="btn-run-suggest">Run</button>
      </div>
      <div id="suggested" class="list"></div>
    </aside>
  </section>

  <!-- ===== Library ===== -->
  <section id="view-library" style="display:none">
    <div class="pane">
      <h3 style="margin:0 0 8px">LIBRARY</h3>
      <div class="projects-bar" id="projects-bar"></div>
      <div class="lib-controls row" style="flex-wrap:wrap">
        <input id="lib-search" type="text" placeholder="Search titles/content" style="flex:1;min-width:220px">
        <input id="lib-tags" type="text" placeholder="#tag1, #tag2" style="min-width:200px">
        <span class="muted">Min links</span><input id="lib-min" type="range" min="0" max="10" step="1" value="0"><span id="lib-min-val" class="badge">0</span>
        <span class="muted">Card size</span><input id="lib-size" type="range" min="160" max="320" step="10" value="220">
        <label class="row"><span class="muted">Newest first</span><input id="lib-sort" type="checkbox" checked style="margin-left:6px"></label>
        <span id="lib-active-project" class="chip" style="display:none;cursor:pointer" title="Click to clear">Project: -</span>
        <button id="lib-clear" class="btn">Clear</button>
      </div>
      <div id="lib-grid" class="lib-grid" style="display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))"></div>
    </div>
  </section>

  <!-- ===== Graph ===== -->
  <section id="view-graph" style="display:none">
    <div class="pane">
      <div class="gctrls">
        <span class="muted">Physics Graph (placeholder)</span>
        <button id="btn-redraw" class="btn">Redraw</button>
      </div>
      <div id="gwrap">
        <canvas id="gcanvas"></canvas>
        <div id="gtooltip" class="tooltip"></div>
      </div>
    </div>
  </section>

  <!-- ===== Forecast ===== -->
  <section id="view-forecast" style="display:none">
    <div class="pane">
      <div class="row space">
        <h3 style="margin:0">Daily Forecasts</h3>
        <div class="row">
          <span class="small">Next auto-generate: <span id="next-forecast-time" class="badge">--</span></span>
          <button id="btn-force-forecast" class="btn" title="Generate today's forecasts now">Generate now</button>
        </div>
      </div>
      <p class="muted small">Forecasts auto-create daily at your set time by scraping public market pages (via a CORS-friendly proxy if configured). If scraping is blocked, a deterministic fallback ensures everyone sees the same set for the day.</p>
      <div class="row" style="flex-wrap:wrap;gap:8px;margin-bottom:8px">
        <label class="row">Daily time (local): <input id="forecast-hour" type="time" value="09:00" style="width:auto"></label>
        <label class="row">CORS proxy (optional): <input id="proxy-url" type="text" placeholder="https://example-worker.workers.dev/fetch?url=" style="min-width:320px"></label>
        <button id="btn-save-forecast-settings" class="btn">Save settings</button>
      </div>
      <div id="forecast-list" class="list"></div>
    </div>
  </section>
</main>

<!-- Toasts container -->
<div id="toasts"></div>

<script>
/* ====================== Storage Helpers ====================== */
const LS = {
  notes: () => JSON.parse(localStorage.getItem('willow.notes')||'[]'),
  saveNotes: (arr) => localStorage.setItem('willow.notes', JSON.stringify(arr)),
  debates: () => JSON.parse(localStorage.getItem('willow.debates')||'[]'),
  saveDebates: (arr) => localStorage.setItem('willow.debates', JSON.stringify(arr)),
  forecasts: () => JSON.parse(localStorage.getItem('willow.forecasts')||'{}'), // by date
  saveForecasts: (obj) => localStorage.setItem('willow.forecasts', JSON.stringify(obj)),
  fcfg: () => JSON.parse(localStorage.getItem('willow.forecast.cfg')||'{}'),
  saveFcfg: (cfg) => localStorage.setItem('willow.forecast.cfg', JSON.stringify(cfg)),
};

/* ====================== Toasts ====================== */
function toast(type, title, text, ms=3500){
  const wrap = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toast'+(type?(' '+type):'');
  el.innerHTML = `<span class="t-title">${title||''}</span><span class="t-text">${text||''}</span><button class="t-close" aria-label="Close">×</button>`;
  el.querySelector('.t-close').onclick = ()=>{el.remove();};
  wrap.appendChild(el);
  setTimeout(()=>{if(el.isConnected) el.classList.add('shake');}, 80);
  if(ms>0) setTimeout(()=>{el.remove();}, ms);
}

/* ====================== Routing & Theme ====================== */
const views = {
  '#/notecard':'view-notecard','#/library':'view-library','#/graph':'view-graph','#/forecast':'view-forecast'
};
function show(h){
  document.querySelectorAll('main > section').forEach(s=>s.style.display='none');
  const id = views[h]||'view-notecard';
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.nav a').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===h));
  if(id==='view-library') renderLibrary();
  if(id==='view-forecast') renderForecastList();
}
window.addEventListener('hashchange',()=>show(location.hash));
show(location.hash||'#/notecard');

document.getElementById('btn-theme').onclick=()=>{
  const dark = document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme', dark?'light':'dark');
  toast('', 'Theme', dark?'Light mode':'Dark mode');
};

/* ====================== Notes ====================== */
let currentNoteId = null;
function renderLeftList(){
  const list = document.getElementById('left-list');
  const notes = LS.notes();
  list.innerHTML = notes.map(n=>`<div class="item" data-id="${n.id}"><div class="t">${n.title||'(untitled)'}</div><div class="muted">${(n.content||'').slice(0,140)}</div></div>`).join('');
  list.querySelectorAll('.item').forEach(it=>it.onclick=()=>openNote(it.getAttribute('data-id')));
}
function openNote(id){
  const n = LS.notes().find(x=>x.id===id);
  if(!n) return;
  currentNoteId = id;
  document.getElementById('nc-title').value = n.title||'';
  document.getElementById('nc-content').value = n.content||'';
  document.getElementById('nc-tags').value = (n.tags||[]).join(', ');
  toast('', 'Opened', n.title||'(untitled)', 1800);
}
function saveNote(){
  const title = document.getElementById('nc-title').value.trim();
  const content = document.getElementById('nc-content').value;
  const tags = document.getElementById('nc-tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  const notes = LS.notes();
  if(currentNoteId){
    const i = notes.findIndex(n=>n.id===currentNoteId);
    if(i>=0){ notes[i] = {...notes[i], title, content, tags, updated:Date.now()}; }
  }else{
    const id = crypto.randomUUID();
    notes.unshift({id, title, content, tags, created:Date.now(), updated:Date.now()});
    currentNoteId = id;
  }
  LS.saveNotes(notes);
  renderLeftList();
  toast('', 'Saved', title||'(untitled)');
}
document.getElementById('btn-save').onclick=saveNote;
document.getElementById('btn-new').onclick=()=>{ currentNoteId=null; document.getElementById('nc-title').value=''; document.getElementById('nc-content').value=''; document.getElementById('nc-tags').value=''; toast('warn','New note','Draft cleared',1800); };
renderLeftList();

/* ====================== Debates (Ask AI) ====================== */
function agentReply(agent, text){
  // Lightweight on-device "style" transform to simulate an agent
  const base = text.trim()||'(no content)';
  switch(agent){
    case 'Historian': return `From precedent:\n• 1870s analogue suggests patience.\n• ${base}`;
    case 'Economist': return `Macro lens:\n• Labor/capacity constraints dominate.\n• ${base}`;
    case 'Contrarian': return `Counterpoint:\n• Check priors; consensus crowded.\n• ${base}`;
    case 'BlindSpot': return `What you're missing:\n• Hidden assumption about causality.\n• ${base}`;
    case 'Interconnectedness': return `Network view:\n• Second/third-order effects matter.\n• ${base}`;
    default: return base;
  }
}
function renderDebateHistory(){
  const box = document.getElementById('debate-history');
  const rows = LS.debates().slice(0,50).map(d=>`<div class="item"><div class="t">${d.agent}</div><div class="muted">${new Date(d.ts).toLocaleString()}</div><div class="mono" style="white-space:pre-wrap">${d.text}</div></div>`).join('');
  box.innerHTML = rows||'<div class="item"><div class="muted">No history yet.</div></div>';
}
renderDebateHistory();

async function askAgent(){
  const agent = document.getElementById('debate-agent').value;
  const content = document.getElementById('nc-content').value||document.getElementById('nc-title').value;
  const out = document.getElementById('debate-output');
  out.textContent = 'Thinking…';
  await new Promise(r=>setTimeout(r, 200)); // small UX delay
  const reply = agentReply(agent, content);
  out.textContent = reply;
  const hist = LS.debates();
  hist.unshift({agent, text: reply, ts: Date.now()});
  LS.saveDebates(hist);
  renderDebateHistory();
  toast('', 'AI replied', agent+' wrote '+(reply.length>80?reply.slice(0,77)+'…':reply));
}
document.getElementById('debate-ask').onclick = askAgent;
document.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ askAgent(); }
});
document.getElementById('debate-add').onclick = ()=>{
  const out = document.getElementById('debate-output').textContent.trim();
  if(!out){ toast('warn','Nothing to add','Ask AI first.'); return; }
  const ta = document.getElementById('nc-content');
  const sep = ta.value.endsWith('\\n')||ta.value==='' ? '' : '\\n\\n';
  ta.value = ta.value + sep + '> ' + out.replace(/\\n/g,'\\n> ') + '\\n';
  toast('', 'Added to note', 'AI output appended as quote.');
};

/* ====================== Library (minimal demo) ====================== */
function seedDemoNotesOnce(){
  const notes = LS.notes();
  if(notes.length) return;
  const sample = Array.from({length:12}, (_,i)=>({id:crypto.randomUUID(),title:`Sample Note ${i+1}`,content:`This is sample content with [[wikilinks]] and tags.`,tags:['demo','sample'],created:Date.now()-i*86400000,updated:Date.now()-i*86400000}));
  LS.saveNotes(sample);
}
seedDemoNotesOnce();

function renderLibrary(){
  const grid = document.getElementById('lib-grid');
  const notes = LS.notes();
  grid.innerHTML = notes.map(n=>`<article class="card" data-id="${n.id}"><div class="title">${n.title||'(untitled)'}</div><div class="preview">${(n.content||'').slice(0,120)}</div><div class="meta"><span class="badge">#${(n.tags||[]).length} tags</span><span class="badge">${(n.content.match(/\\[\\[/g)||[]).length} links</span></div></article>`).join('');
  grid.querySelectorAll('.card').forEach(c=>c.onclick=()=>{location.hash='#/notecard'; openNote(c.getAttribute('data-id'));});
}

/* ====================== Graph (very light placeholder) ====================== */
function drawGraph(){
  const canvas = document.getElementById('gcanvas');
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.clientWidth;
  const h = canvas.height = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--g-stroke');
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let x=0;x<w;x+=8){
    const y = h/2 + Math.sin(x/30)*40;
    ctx.lineTo(x,y);
  }
  ctx.stroke();
}
window.addEventListener('resize', drawGraph);
document.getElementById('btn-redraw').onclick=drawGraph;
setTimeout(drawGraph,0);

/* ====================== Forecasts ====================== */
/**
 * Goals:
 * - Auto-generate forecasts daily at a configured local time
 * - Try to scrape public market pages using DOMParser through an optional CORS proxy
 * - If blocked, generate deterministic fallback items based on the date so everyone sees the same list
 * - Persist per-day results in localStorage to avoid duplicates
 */
const DEFAULT_SOURCES = [
  {name:'Polymarket: US CPI YoY', url:'https://polymarket.com/event/us-inflation-cpi-yoy', selector:'[data-testid="market-card"], article, a'},
  {name:'Kalshi: Fed Rate by EOY', url:'https://kalshi.com/markets/fed-funds-rate', selector:'a, article'}
];

function xmur3(str){for(var i=0,h=1779033703^str.length;i<str.length;i++)h=Math.imul(h^str.charCodeAt(i),3432918353),h=h<<13|h>>>19;return function(){h=Math.imul(h^h>>>16,2246822507),h=Math.imul(h^h>>>13,3266489909);return(h^h>>>16)>>>0}}
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}

async function fetchThroughProxy(rawUrl, proxy){
  const final = proxy ? proxy + encodeURIComponent(rawUrl) : rawUrl;
  const res = await fetch(final, {mode: proxy ? 'cors' : 'cors'}); // may fail CORS without proxy
  const txt = await res.text();
  return new DOMParser().parseFromString(txt, 'text/html');
}

async function tryScrape(proxy){
  const items = [];
  for(const src of DEFAULT_SOURCES){
    try{
      const doc = await fetchThroughProxy(src.url, proxy);
      // Very loose extraction: grab up to 5 distinct text blobs that look like market lines
      const nodes = Array.from(doc.querySelectorAll(src.selector)).slice(0,8);
      const picks = nodes.map(n=> (n.textContent||'').trim().replace(/\\s+/g,' ')).filter(t=>t.length>30).slice(0,3);
      picks.forEach((t,idx)=>{
        items.push({
          id: crypto.randomUUID(),
          source: src.name,
          title: t.slice(0,80),
          probability: Math.round(25 + Math.random()*50),
          url: src.url
        });
      });
    }catch(e){
      console.warn('Scrape failed for', src.url, e);
    }
  }
  return items;
}

function deterministicFallback(isoDate){
  const seed = xmur3(isoDate)();
  const rnd = mulberry32(seed);
  const templates = [
    ['US CPI YoY in next print ≥ 3.5%','Macro'],
    ['Fed cuts at next meeting?','Rates'],
    ['BTC closes week above prior high','Crypto'],
    ['WTI settles above $90 this month','Energy'],
    ['S&P 500 drawdown > 3% this week','Equities'],
    ['EURUSD ends month > 1.11','FX'],
  ];
  const out = [];
  for(let i=0;i<4;i++){
    const t = templates[Math.floor(rnd()*templates.length)];
    out.push({
      id: `${isoDate}-${i}`,
      source: 'Deterministic',
      title: t[0],
      probability: Math.round(30 + rnd()*50),
      url: '#',
      tag: t[1]
    });
  }
  return out;
}

function renderForecastList(){
  const list = document.getElementById('forecast-list');
  const today = new Date().toISOString().slice(0,10);
  const store = LS.forecasts();
  const todays = store[today]||[];
  list.innerHTML = (todays.length?todays:[]).map(f=>`
    <div class="item" data-id="${f.id}">
      <div class="t">${f.title}</div>
      <div class="muted">${f.source} • ${f.probability}% • ${new Date(f.ts||Date.now()).toLocaleString()} ${f.url&&f.url!=='#' ? '• <a href="'+f.url+'" target="_blank">source</a>' : ''}</div>
    </div>
  `).join('') || '<div class="item"><div class="muted">No forecasts yet for today.</div></div>';
}

function scheduleNextRun(){
  const cfg = {hour: '09:00', proxy: '', ...LS.fcfg()};
  const [hh,mm] = cfg.hour.split(':').map(Number);
  const now = new Date();
  const next = new Date(now);
  next.setHours(hh,mm,0,0);
  if(next <= now){ next.setDate(next.getDate()+1); }
  const span = document.getElementById('next-forecast-time');
  span.textContent = next.toLocaleString();
  // Set timeout for next run (cap at 24h)
  const delay = Math.min(24*3600e3, next - now);
  if(window._forecastTimer) clearTimeout(window._forecastTimer);
  window._forecastTimer = setTimeout(()=>{ generateTodayForecasts(); }, delay);
}

async function generateTodayForecasts(force=false){
  const cfg = {hour: '09:00', proxy: '', ...LS.fcfg()};
  const today = new Date().toISOString().slice(0,10);
  const all = LS.forecasts();
  if(all[today] && all[today].length && !force){
    renderForecastList();
    toast('','Forecasts','Already generated for today.');
    return;
  }
  toast('','Forecasts','Generating…');
  let items = await tryScrape(cfg.proxy);
  if(!items.length){
    items = deterministicFallback(today);
    toast('warn','Scrape blocked','Using deterministic fallback for today.');
  }
  const withTs = items.map(x=>({...x, ts: Date.now()}));
  all[today] = withTs;
  LS.saveForecasts(all);
  renderForecastList();
  toast('','Forecasts ready', `${withTs.length} items for ${today}`);
  scheduleNextRun();
}

document.getElementById('btn-force-forecast').onclick=()=>generateTodayForecasts(true);
document.getElementById('btn-save-forecast-settings').onclick=()=>{
  const hour = (document.getElementById('forecast-hour').value||'09:00').slice(0,5);
  const proxy = document.getElementById('proxy-url').value.trim();
  LS.saveFcfg({hour, proxy});
  toast('', 'Saved', 'Daily time & proxy updated.');
  scheduleNextRun();
};
// Initialize forecast UI
(function initForecast(){
  const cfg = {hour: '09:00', proxy: '', ...LS.fcfg()};
  document.getElementById('forecast-hour').value = cfg.hour;
  document.getElementById('proxy-url').value = cfg.proxy||'';
  scheduleNextRun();
  // Also generate if today is empty and time has already passed
  const [hh,mm] = cfg.hour.split(':').map(Number);
  const now = new Date();
  const timePassed = now.getHours()>hh || (now.getHours()===hh && now.getMinutes()>=mm);
  const today = new Date().toISOString().slice(0,10);
  const all = LS.forecasts();
  if((!all[today] || !all[today].length) && timePassed){
    generateTodayForecasts();
  }else{
    renderForecastList();
  }
})();

/* ====================== Import / Export ====================== */
document.getElementById('btn-export').onclick=()=>{
  const blob = new Blob([JSON.stringify({
    notes: LS.notes(),
    debates: LS.debates(),
    forecasts: LS.forecasts(),
    forecast_cfg: LS.fcfg()
  }, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'willow-export.json'; a.click();
  URL.revokeObjectURL(url);
  toast('', 'Exported', 'Data downloaded as JSON.');
};
document.getElementById('file-import').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  try{
    const data = JSON.parse(text);
    if(data.notes) LS.saveNotes(data.notes);
    if(data.debates) LS.saveDebates(data.debates);
    if(data.forecasts) LS.saveForecasts(data.forecasts);
    if(data.forecast_cfg) LS.saveFcfg(data.forecast_cfg);
    renderLeftList(); renderDebateHistory(); renderForecastList();
    toast('', 'Imported', file.name);
  }catch(err){
    console.error(err); toast('err','Import failed','Invalid JSON');
  }
});

/* ====================== Nav links ====================== */
document.getElementById('nav-notecard').onclick=()=>location.hash='#/notecard';
document.getElementById('nav-library').onclick=()=>location.hash='#/library';
document.getElementById('nav-graph').onclick=()=>location.hash='#/graph';
document.getElementById('nav-forecast').onclick=()=>location.hash='#/forecast';
</script>
</body>
</html>
